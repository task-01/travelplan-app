<div class="top">
  <div class="travelplan_search_area">
    <div class="search_area">
      <div class="search_form">
        <h1 class="fw-bold">旅行プラン一覧</h1>
        <p class="fs-5">旅行プラン一覧では、他のユーザーが投稿した旅行プランを見ることができます。投稿を絞り込む場合は、検索機能をお使いください。</p>
        <p class="fs-5">総旅行プラン件数: <%= @travelplan_count %>件</p>
      </div>
    </div>
  </div>
  <div class="travelplan_list">
    <div class="sort_filter_area">
      <div class="border-start border-end border-secondary border-3 sort-options d-flex justify-content-between">
        <span class="text-white fw-bold">並び順</span>
        <div>
          <%= link_to '新しい順', travelplans_path(sort_order: 'newest'), 
            class: "border-3 mx-1 #{params[:sort_order] == 'newest' ? 'text-dark' : 'text-white'}" %>
          <span>|</span>
          <%= link_to '古い順', travelplans_path(sort_order: 'oldest'), 
            class: "border-3 mx-1 #{params[:sort_order] == 'oldest' ? 'text-dark' : 'text-white'}" %>
          <span>|</span>
          <%= link_to '宿泊日数が多い順', travelplans_path(sort_order: 'most_days'), 
            class: "border-3 mx-1 #{params[:sort_order] == 'most_days' ? 'text-dark' : 'text-white'}" %>
          <span>|</span>
          <%= link_to '宿泊日数が少ない順', travelplans_path(sort_order: 'least_days'), 
            class: "border-3 mx-1 #{params[:sort_order] == 'least_days' ? 'text-dark' : 'text-white'}" %>
          <span>|</span>
          <%= link_to 'いいね順', travelplans_path(sort_order: 'likes'), 
            class: "border-3 mx-1 #{params[:sort_order] == 'likes' ? 'text-dark' : 'text-white'}" %>
        </div>   
      </div>
      <hr>
      <div class="border-start border-end border-secondary border-3 filter-options field-area">
        <%= search_form_for @q, url: travelplans_path, method: :get, local: true do |f| %>
          <div class="field form-group d-flex justify-content-between align-items-center">
            <h5 class="text-white text-start mb-0 fw-bold">キーワード</h5>
            <%= f.search_field :gpt_response_or_prefecture_name_or_tourist_spot_or_number_day_or_travelplan_name_cont, placeholder: 'キーワードを入力', class: 'form-control' %>
          </div>
          <div class="field form-group d-flex justify-content-between align-items-center">
            <h5 class="text-white text-start mb-0 fw-bold">宿泊日数</h5>
            <%= f.select :number_day_eq, options_for_select([["未選択", nil]] + @number_days, params[:q]&.[](:number_day_eq)), 
              id: 'number_days', class: "number_days text-end" %>
          </div>
          <div class="field form-group d-flex justify-content-between align-items-center">
            <h5 class="text-white text-start mb-0 fw-bold">都道府県名</h5>
            <%= f.select :prefecture_name_eq, options_for_select([["未選択", nil]] + @prefecture_names, params[:q]&.[](:prefecture_name_eq)), 
              id: 'dropdown_prefectures', class: "prefecture_names text-end" %>
          </div>
          <div class="text-end">
            <%= f.submit '絞り込み', class: 'btn filter hover-transform' %>
          </div>
        <% end %>
      </div>
      <hr>
    </div>
    <% @travelplans.each do |travelplan| %>
      <% if current_user && current_user.likes?(travelplan)  %>
        <%= link_to destroy_like_travelplan_path(travelplan), method: :delete, remote: true, class: 'btn btn-outline-danger like-button like', id: "like-button-#{travelplan.id}" do %>
          <i class="fas fa-heart"></i><%= @likes_counts[travelplan.id] || 0 %>
        <% end %>
      <% else %>
        <%= link_to create_like_travelplan_path(travelplan), method: :post, remote: true, class: 'btn btn-outline-secondary like-button', id: "like-button-#{travelplan.id}" do %>
          <i class="far fa-heart"></i><%= @likes_counts[travelplan.id] || 0 %>
        <% end %>
      <% end %>
      <% image_url = "https://potepanecportfolio.s3.ap-northeast-1.amazonaws.com/prefectures/#{prefecture_to_english(travelplan.prefecture_name)}.png" %>
      <div class="title-image-area mb-3" style="background-image: url('<%= image_url %>');">
        <div class="d-flex flex-row bd-highlight travels-prefecture">
          <h1 class="travelplan_prefecture_name"><%= travelplan.prefecture_name %></h1>
          <p class="text-white mt-4 travelplans-day">宿泊日数：<%= travelplan.number_day %>泊</p>
          <p class="text-white mt-4 travelplans-day">
            <% travelplan.users.each do |user| %>
              <%= user.name %>さんの旅行プラン
            <% end %>
          </p>
          <p class="text-white detail">詳細</p>
        </div>
        <div class="set-travels-area">
          <ol class="d-flex flex-wrap list-group">
            <% response_lines = travelplan.gpt_response.split("\n") %>
            <% day_counter = 0 %>
            <% plan_content = [] %>
            <% response_lines.each do |line| %>
              <% if line.match?(/Day|日目/) && !plan_content.empty? && day_counter != 0 %>
                <li class="travals-history list-group-item bg-transparent border-0">
                  <div class="travel-text-area">
                    <h5 class="ms-2 mt-2 mb-0 me-auto fw-bold"><%= day_counter %>day</h5>
                    <hr width="ms-2 me-auto auto">
                    <% plan_content.each do |content| %>
                      <p class="ms-2 me-auto"><%= content.gsub('-', '').strip %></p>
                    <% end %>
                  </div>
                </li>
                <% plan_content.clear %>
                <% day_counter += 1 %>
              <% elsif line.match?(/Day|日目/) %>
                <% day_counter += 1 %>
              <% else %>
                <% plan_content << line %>
              <% end %>
            <% end %>
            <% if !plan_content.empty? %>
              <li class="travals-history list-group-item bg-transparent border-0">
                <div class="travel-text-area">
                  <h5 class="ms-2 mt-2 mb-0 me-auto fw-bold"><%= day_counter.zero? ? 1 : day_counter %>day</h5>
                  <hr width="ms-2 me-auto auto">
                  <% plan_content.each do |content| %>
                    <p class="ms-2 me-auto"><%= content.gsub('-', '').strip %></p>
                  <% end %>
                </div>
              </li>
            <% end %>
          </ol>
          <button class="close-button">閉じる</button>
        </div>
      </div>
    <% end %>
    <% unless @travelplan&.present? %>
      <div class="travelplan-none">
        <p>該当する結果がありませんでした</p>
      </div>
    <% end %>
  </div>
</div>
<script>
$(document).ready(function() {
  $('.travels-prefecture, .close-button').on('click', function() {
    let contentArea = $(this).hasClass('travels-prefecture') ? $(this).next(".set-travels-area") : $(this).parent(".set-travels-area");
    contentArea.slideToggle(function() {
      if (!contentArea.is(':visible')) {
        $('html, body').scrollTop(contentArea.prev('.travels-prefecture').offset().top);
      }
    });
    $(this).toggleClass('close');
  });
});
</script>
