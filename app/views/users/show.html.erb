<% if session[:kept_flash] %>
  <div id="flash-message" class="px-3 flash-message bg-warning">
    <%= session[:kept_flash] %>
  </div>
<% end %>
<% if @travelplan&.present? || @user.first_travelplan %> 
  <div id="loading-animation" class="loading-animation">
    <div class="loading-bar"></div>
  </div>
<% end %> 
<div class="top" data-turbolinks-permanent data-page-id="<%= @user.id %>" data-travelplan-id="<%= @travelplan&.id %>">
  <div class="show-image-class">
    <% if @travelplan && @travelplan.prefecture_name&.match?(/都|道|府|県/) %>
      <% image_url = "https://potepanecportfolio.s3.ap-northeast-1.amazonaws.com/prefectures/#{prefecture_to_english(@travelplan.prefecture_name)}.png" %>
      <div class="prefecture-image-area" 
        style="background-image: url('<%= image_url %>');">
    <% else %>
      <div class="show-image-area">
    <% end %>
    <div class="show-mypage-area">
      <div class="show-top">
        <div class="show-mypage">
          <div class="user-section">
            <div class="defult-image">
              <%= image_tag "user_image/user_image.png" %>
            </div>
            <div class="show-user"><%= @user.name %></div>
          </div>
          <div class="edit-area">
            <%= link_to "プロフィール編集", "#", class: "btn btn-secondary editpage" %>
          </div>
        </div>
        <div class="show-top-footer mt-5">
          <ul class="list-group list-group-horizontal justify-content-between mypage-travel-area">
            <span class="border border-secondary"></span>
            <li class="list-group-item">
              旅行プラン投稿数
            </li>
            <span class="border border-secondary"></span>
            <li class="list-group-item">
              いいね数
            </li>
            <span class="border border-secondary"></span>
            <li class="list-group-item">
              旅行数
            </li>
            <span class="border border-secondary"></span>
          </ul>
        </div>
      </div>
    </div>
    </div>
    <% if @travelplan&.present? %>
      <div class="item-contents">
        <div class="tab-area d-flex justify-content-around">
          <div class="tab active border-2 border-start border-end border-secondary" data-value='1' >
            <h3>セット中の旅行プラン</h3>
          </div>
          <div class="tab border-2 border-start border-end border-secondary" data-value='2' >
            <h3>いいね履歴</h3>
          </div>
          <div class="tab border-2 border-start border-end border-secondary" data-value='3' >
            <h3>旅行プラン履歴</h3>
          </div>
        </div>
      </div>
      <div class="content-area">
        <div class="content show">
          <%= render 'shared/set_travel' %>
        </div>
        <div class="content">
          <p>こんち</p>
        </div>
        <div class="content">
          <%= render 'shared/travelplan_history' %>
        </div>
      </div>
    <% else %>
      <%= render 'shared/default_show' %>
    <% end %>
  </div>
</div>
<script>
function updateNotificationArea() {
  const pageId = $(".top").data("page-id");
  const travelplanId = $(".top").data("travelplan-id");
  $.ajax({
    url: "/users/" + pageId,
    type: 'GET',
    dataType: 'json',
    headers: {
      'Accept': 'application/json'
    },
    success: function(response) {
      if (response.job_status === "completed") {
        $('.loading-bar').css('animation-play-state', 'paused').css('width', '100%');
        $.ajax({
          url: `/travelplans/${travelplanId}/set_in_progress`,
          type: 'POST',
          dataType: 'json',
          beforeSend: function(xhr) {
            xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
          },
        });
        location.reload();
      } else {
        if ($('.loading-bar').width() >= $('.loading-bar').parent().width() * 0.85) {
          $('.loading-bar').css('animation-play-state', 'paused');
        }
        setTimeout(function() {
          updateNotificationArea();
        }, 3000);
      }
    },
  });
};

document.addEventListener("turbolinks:load", function() {
  const currentTravelPlanId = $(".top").data("travelplan-id");
  const previousTravelPlanId = localStorage.getItem("travelplanId");
  if (currentTravelPlanId != previousTravelPlanId) {
    $("#loading-animation").show();
  } else {
    $("#flash-message").text("旅行プランが作成されました！");
    $("#loading-animation").hide();
  }
  localStorage.setItem("travelplanId", currentTravelPlanId);
  const tabs = $(".tab");
  tabs.on("click", function() {
    $(".active").removeClass("active");
    $(this).addClass("active");
    const index = tabs.index(this);
    $(".content").removeClass("show").eq(index).addClass("show");
  });
  
  updateNotificationArea();
});
</script>
